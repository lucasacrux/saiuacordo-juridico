<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<base href="/" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SaiuAcordo • Calculadora (Antecipação)</title>

<!-- Tema Claro/Dark (harmonizado) -->
<style>
  :root{
    --bg:#F5F7FA; --card:#FFFFFF; --soft:#FAFBFF; --text:#1F2937; --muted:#6B7280; --border:#E5E7EB;
    --brand-ink:#070c7b; --brand:#0B5ED7; --brand-700:#0848A8;
    --ok:#16A34A; --ok-700:#11803A; --warn:#B45309; --bad:#DC2626;
    --thead:#EEF2FF; --row:#F9FAFB; --row-hover:#F3F6FF; --focus:#93C5FD; --shadow:0 8px 30px rgba(9,30,66,.06);
  }
  /* Overrides para dark */
  .theme-dark{
    --bg:#0f1222; --card:#151935; --soft:#1b2042; --text:#e8ecf3; --muted:#9aa3b2; --border:#2a2f53;
    --brand-ink:#e6e8ff; --brand:#8A05BE; --brand-700:#6b0495;
    --ok:#1DB954; --ok-700:#159c44; --warn:#e5a100; --bad:#e94b4b;
    --thead:#11162f; --row:#0e1330; --row-hover:#151a3a; --focus:#3b82f6; --shadow:0 10px 30px rgba(0,0,0,.25);
  }

  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .container{max-width:960px;margin:0 auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:var(--shadow);margin-bottom:12px}
  h1,h2,h3{margin:0 0 8px;color:var(--brand-ink)}
  .hint{color:var(--muted);font-size:12px}

  .btn{border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;background:var(--brand);color:#fff}
  .btn:hover{background:var(--brand-700)}
  .btn-outline{background:#fff;color:var(--brand);border:1px solid var(--brand)}
  .theme-dark .btn-outline{background:transparent;color:#fff;border-color:#3a3f6a}
  .btn-outline:hover{background:#F5F9FF}
  .theme-dark .btn-outline:hover{background:#23284f}
  .btn[disabled]{opacity:.55;cursor:not-allowed}

  .form-row{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap}
  .field{display:flex;flex-direction:column;gap:6px}
  label{font-size:12px;color:var(--muted)}
  input,select{background:#fff;border:1px solid var(--border);color:var(--text);padding:10px;border-radius:12px;min-width:160px}
  .theme-dark input,.theme-dark select{background:var(--soft);border-color:var(--border);color:var(--text)}
  :focus{outline:2px solid var(--focus);outline-offset:2px;border-radius:10px}

  /* Tabelas */
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid var(--border);text-align:center;font-size:14px}
  thead th{position:sticky;top:0;background:var(--thead);z-index:1}
  tbody tr:nth-child(even){background:var(--row)}
  tbody tr:hover{background:var(--row-hover)}
  .money{text-align:right}
  .table-wrap{overflow:auto;max-height:320px;border:1px solid var(--border);border-radius:12px; background:#fff}
  .theme-dark .table-wrap{background:var(--card)}

  /* Stats */
  .stats{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin-top:6px}
  .stat{background:var(--soft);border:1px solid var(--border);border-radius:12px;padding:12px}
  .stat span{display:block;color:var(--muted);font-size:12px}
  .stat strong{display:block;margin-top:4px;font-size:16px}

  /* Comparativo */
  .compare{display:flex;gap:14px;flex-wrap:wrap;margin-top:12px}
  .compare .box{flex:1 1 280px;background:var(--soft);border:1px solid var(--border);border-radius:12px;padding:12px}
  .compare h4{margin:0 0 8px;color:var(--brand)}
  .row-just{display:flex;justify-content:space-between;margin:6px 0}
  .tag-ok{color:#16A34A} .tag-warn{color:#B45309}

  /* Presets (tabela clicável) */
  .clickable-row{cursor:pointer}
  .clickable-row td:first-child{font-weight:700}

  /* Mobile */
  @media (max-width:640px){
    .container{padding:12px}
    .form-row{flex-direction:column;align-items:stretch}
    .btn{width:100%}
    table{min-width:640px}
  }

  /* Modal taxa */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.25);display:none;align-items:center;justify-content:center;padding:12px}
  .modal .box{background:#fff;border-radius:12px;max-width:460px;width:100%;padding:16px;border:1px solid var(--border);color:#222;box-shadow:var(--shadow)}
  .theme-dark .modal .box{background:#151935;border-color:#2a2f53;color:#e8ecf3}
  .modal .box h3{margin:0 0 8px;color:var(--brand-ink)}

  /* Avisos de elegibilidade */
  .alert{border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:6px;font-size:14px}
  .alert-ok{background:rgba(22,163,74,.08);border-color:rgba(22,163,74,.35)}
  .alert-bad{background:rgba(220,38,38,.08);border-color:rgba(220,38,38,.35)}
  .alert ul{margin:8px 0 0 18px;padding:0}
</style>
</head>
<body>
  <div class="container">

    <!-- Toolbar -->
    <div class="card">
      <div class="form-row" style="justify-content:space-between">
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-outline" id="btnSelecionarOp">← Selecionar operação</button>
          <button class="btn btn-outline" id="btnNovaBusca">← Nova busca por CPF</button>
        </div>
        <div class="hint" id="toolbarInfo"></div>
      </div>
    </div>

    <!-- ELEGIBILIDADE -->
    <div class="card" id="eligCard" style="display:none">
      <h2>Elegibilidade</h2>
      <div class="alert" id="eligAlert"></div>
      <div class="hint" id="eligHint"></div>
    </div>

    <!-- PARCELAS ATUAIS (6 colunas) -->
    <div class="card">
      <h2>Parcelas atuais do acordo</h2>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>1) Nº parcela</th>
              <th>2) Valor parcela</th>
              <th>3) Vencimento</th>
              <th>4) Valor Presente</th>
              <th>5) Valor pago</th>
              <th>6) Data de pagamento</th>
            </tr>
          </thead>
          <tbody id="tbodyParcelas"><tr><td colspan="6" style="text-align:left;padding:14px">Carregando acordo...</td></tr></tbody>
        </table>
      </div>
      <div class="hint" id="resumoAcordo"></div>
    </div>

    <!-- CALCULADORA -->
    <div class="card">
      <h2>Calculadora</h2>

      <!-- Linha 1: tipo + taxa + stats -->
      <div class="form-row">
        <div class="field">
          <label>Tipo de operação</label>
          <div class="hint">Antecipação</div>
        </div>
        <div class="field">
          <label>Definir taxa anual</label>
          <div style="display:flex;gap:8px">
            <button class="btn btn-outline" id="btnAnt">Definir taxa</button>
          </div>
        </div>
      </div>
      <div class="stats" id="stats">
        <div class="stat"><span>Saldo devedor (FV)</span><strong>—</strong></div>
        <div class="stat"><span>Valor Presente (VP)</span><strong>—</strong></div>
        <div class="stat"><span>Taxa aplicada</span><strong>—</strong></div>
      </div>

      <!-- Linha 2: presets -->
      <div class="field" style="margin-top:10px">
        <label>Conjuntos pré-definidos</label>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Meses</th><th>Parcela (calculada)</th></tr></thead>
            <tbody id="tabelaSugestoes"><tr><td colspan="2">Defina a taxa para ver sugestões.</td></tr></tbody>
          </table>
        </div>
        <div class="hint">Toque em <em>Meses</em> para simular por prazo, ou em <em>Parcela</em> para simular por valor.</div>
      </div>

      <!-- Linha 3: formulários (botões na mesma linha) -->
      <div class="form-row" style="margin-top:6px">
        <div class="field" style="max-width:320px">
          <label for="valorParcela">Valor da parcela (R$)</label>
          <div class="form-row">
            <input type="text" id="valorParcela" placeholder="Ex.: 450,00" />
            <button class="btn" id="btnPorValor">Calcular por valor</button>
          </div>
        </div>
        <div class="field" style="max-width:260px">
          <label for="numParcelas">Número de parcelas</label>
          <div class="form-row">
            <input type="number" id="numParcelas" placeholder="Ex.: 36" />
            <button class="btn" id="btnPorPrazo">Calcular por prazo</button>
          </div>
        </div>
      </div>

      <!-- Linha 4: limites -->
      <div class="form-row" style="margin-top:6px">
        <div class="field" style="max-width:220px">
          <label for="maxParcelas">Máximo de parcelas</label>
          <input type="number" id="maxParcelas" value="48" readonly>
        </div>
        <div class="field" style="max-width:220px">
          <label for="minParcela">Valor mínimo (R$)</label>
          <input type="text" id="minParcela" value="100,00" readonly>
        </div>
      </div>
    </div>

    <!-- RESULTADO -->
    <div class="card">
      <h2>Resultado da simulação</h2>
      <div id="resultado" aria-live="polite"></div>
    </div>

  </div>

  <!-- Bridge deve vir ANTES da lógica local -->
  <script src="/_sa-bridge.js"></script>
  <!-- Helper único de elegibilidade (opcional: hospede como /_sa-elig.js). Se não existir, o fallback abaixo define. -->
  <script src="/_sa-elig.js"></script>
  <script>
  // ===== Fallback do helper (idempotente): só cria se não existir window.SAElig =====
  (function(w){
    if (w.SAElig) return;
    function onlyDigits(s){ return String(s||'').replace(/\D+/g,''); }
    function dateOnly(d){
      if (!d) return null;
      if (d instanceof Date && !isNaN(d)) return new Date(d.getFullYear(), d.getMonth(), d.getDate());
      if (typeof d === 'string'){
        const s = d.trim();
        if (/^\d{4}-\d{2}-\d{2}/.test(s)){ const [y,m,day] = s.split('T')[0].split('-').map(Number); return new Date(y, m-1, day); }
        if (/^\d{2}\/\d{2}\/\d{4}$/.test(s)){ const [day,m,y] = s.split('/').map(Number); return new Date(y, m-1, day); }
        const n = new Date(s); if (!isNaN(n)) return new Date(n.getFullYear(), n.getMonth(), n.getDate()); return null;
      }
      const n = new Date(d); return isNaN(n) ? null : new Date(n.getFullYear(), n.getMonth(), n.getDate());
    }
    function isParcelaPaga(p){
      const st  = String(p?.situacao || p?.situacaoPagamento || '').toUpperCase();
      const pagoPorStatus = /(LIQUID|QUITAD|PAG[OA]|RECEBID|PROCESS)/.test(st);
      const pagoPorValor  = Number(p?.valor_pago||p?.valorPago||0) >= Math.max(0, Number(p?.valor||0));
      const temDataPg     = !!(p?.data_pagamento || p?.dataPagamento);
      return pagoPorStatus || pagoPorValor || temDataPg;
    }
    function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
    function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0); }
    function hasAbertaEmAtraso(parcelas, ref){
      const hoje = dateOnly(ref||new Date());
      return (parcelas||[]).some(p=>{
        const dv = dateOnly(p?.dataVencimento || p?.vencimento);
        return dv && dv < hoje && !isParcelaPaga(p);
      });
    }
    function parcelaDoMesOk(parcelas, ref){
      const hoje = dateOnly(ref||new Date());
      const ini = startOfMonth(hoje), fim = endOfMonth(hoje);
      const doMes = (parcelas||[]).filter(p=>{
        const dv = dateOnly(p?.dataVencimento || p?.vencimento);
        return dv && dv >= ini && dv <= fim;
      });
      if (!doMes.length){
        // se não há parcela neste mês, OK desde que não haja atraso aberto
        return !hasAbertaEmAtraso(parcelas, hoje);
      }
      return doMes.every(p=>{
        const dv = dateOnly(p?.dataVencimento || p?.vencimento);
        return isParcelaPaga(p) || (dv && dv >= hoje);
      });
    }
    function saldoAberto(parcelas){
      return (parcelas||[]).reduce((s,p)=> s + (isParcelaPaga(p) ? 0 : Number(p?.valor||0)), 0);
    }
    function getSituacaoCode(ac){
      // 0 normal, 1 quebrado, 2 atrasado, 3 liquidado
      if (ac?.situacao != null && !isNaN(Number(ac.situacao))) return Number(ac.situacao);
      const s = (String(ac?.situacaoAcordo ?? ac?.status ?? '').toUpperCase());
      if (/LIQUID/.test(s)) return 3;
      if (/QUEBR/.test(s))  return 1;
      if (/ATRAS/.test(s))  return 2;
      return 0;
    }
    function isAtivoStrict(ac){ return String(ac?.active ?? ac?.Active ?? '').trim().toUpperCase() === 'ATIVO'; }
    function hydrateParcelas(ac){
      if (Array.isArray(ac.parcelas) && ac.parcelas.length) return ac;
      const alvoId = String(ac?.acordoId ?? ac?.id ?? '');
      for (let i=0; i<sessionStorage.length; i++){
        const k = sessionStorage.key(i); if (k === 'wizard.acordo') continue;
        try{
          const obj = JSON.parse(sessionStorage.getItem(k));
          const candidatos = []
            .concat(Array.isArray(obj)? obj : [])
            .concat(Array.isArray(obj?.result)? obj.result : [])
            .concat(Array.isArray(obj?.acordos)? obj.acordos : [])
            .concat(Array.isArray(obj?.acordo_ativo)? obj.acordo_ativo : []);
          for (const c of candidatos){
            if (String(c?.acordoId ?? c?.id ?? '') === alvoId && Array.isArray(c?.parcelas)){
              ac.parcelas = c.parcelas; return ac;
            }
          }
        }catch(_){}
      }
      return ac;
    }
    function compute(acordo, origem){
      const ac = hydrateParcelas(acordo||{});
      const parcelas = Array.isArray(ac.parcelas)? ac.parcelas : [];
      const ativo = origem !== 'contrato-sem-acordo' ? isAtivoStrict(ac) : false;
      const sit   = getSituacaoCode(ac); // 0 normal, 1 quebrado, 2 atrasado, 3 liquidado

      const semAtrasoAberto = !hasAbertaEmAtraso(parcelas);
      const parcelaMesOK    = parcelaDoMesOk(parcelas);

      // Refinanciamento: ativo, não liquidado e com saldo aberto
      const podeRefi  = (origem !== 'contrato-sem-acordo') && ativo && (sit !== 3) && (saldoAberto(parcelas) > 0);

      // Antecipação: ativo, normal, sem atraso aberto e parcela do mês ok
      const podeAntec = (origem !== 'contrato-sem-acordo') && ativo && (sit === 0) && semAtrasoAberto && parcelaMesOK;

      const reasonsAntec = [];
      if (origem === 'contrato-sem-acordo') reasonsAntec.push('Não há acordo ativo para este contrato.');
      if (!ativo)                             reasonsAntec.push('Acordo não está ATIVO.');
      if (sit !== 0)                          reasonsAntec.push('Situação do acordo não é NORMAL.');
      if (!semAtrasoAberto)                   reasonsAntec.push('Existe parcela em atraso aberta.');
      if (!parcelaMesOK)                      reasonsAntec.push('Parcela do mês não está paga nem a vencer.');

      return { ativo, sit, semAtrasoAberto, parcelaMesOK, podeRefi, podeAntec, reasonsAntec, parcelas };
    }
    w.SAElig = { compute, utils:{ dateOnly, isParcelaPaga, hasAbertaEmAtraso, parcelaDoMesOk, saldoAberto, getSituacaoCode } };
  })(window);
  </script>

  <!-- Modal: taxa anual -->
  <div class="modal" id="modalTaxa" aria-hidden="true">
    <div class="box">
      <h3>Definir taxa anual</h3>
      <div class="hint" id="modalHint">Informe a taxa anual para a operação.</div>
      <div class="form-row" style="margin-top:8px">
        <div class="field">
          <label for="taxaAnualInput">Taxa anual (%)</label>
          <input type="number" id="taxaAnualInput" step="0.01" min="0" value="20">
        </div>
        <button class="btn" id="confirmTaxa">Confirmar</button>
      </div>
    </div>
  </div>

<script>
(function(){
  /* ========= Tema (QS + sessionStorage) ========= */
  function getQS(){ try{ return new URLSearchParams(location.search); }catch(_){ return new URLSearchParams(''); } }
  function applyThemeFromContext(){
    let t = 'light';
    try{
      const qs = getQS();
      t = (qs.get('theme') || sessionStorage.getItem('ui.theme') || 'light').toLowerCase();
      sessionStorage.setItem('ui.theme', t);
    }catch(_){}
    document.body.classList.toggle('theme-dark', t === 'dark');
  }
  applyThemeFromContext();

  /* ========= Navegação (usa _sa-bridge quando disponível) ========= */
  function pick(obj, keys){ const o={}; keys.forEach(k=>{ const v=obj.get(k); if(v!=null && v!=='') o[k]=v; }); return o; }
  function buildUrl(base, extra){
    const qs = getQS();
    const keep = pick(qs, ['theme','returnTo','cpf','contrato','from']);
    const params = new URLSearchParams({...keep, ...(extra||{})});
    const q = params.toString();
    return q ? `${base}?${q}` : base;
  }

  function backToEscolha(){
    if (window.__SA && typeof window.__SA.toEscolhaOperacao === 'function'){
      window.__SA.toEscolhaOperacao(); // bridge preserva QS
      return;
    }
    location.assign(buildUrl('/escolha-operacao/index.html'));
  }

  function novaBusca(){
    try{
      sessionStorage.removeItem('wizard.operacao');
      sessionStorage.removeItem('wizard.acordo');
      sessionStorage.removeItem('wizard.cpf');
    }catch(_){}
    if (window.__SA && typeof window.__SA.toConsulta === 'function'){
      window.__SA.toConsulta(); // para /home-consulta mantendo theme/returnTo
      return;
    }
    location.assign(buildUrl('/home-consulta'));
  }

  document.getElementById('btnSelecionarOp').addEventListener('click', backToEscolha);
  document.getElementById('btnNovaBusca').addEventListener('click', novaBusca);

  /* ========= Estado / Utils ========= */
  const acordoRaw = sessionStorage.getItem('wizard.acordo');
  if(!acordoRaw){
    if (window.__SA && typeof window.__SA.toAcordos === 'function') window.__SA.toAcordos();
    else location.replace(buildUrl('/acordos/home/index.html'));
    return;
  }
  const acordo = JSON.parse(acordoRaw||'{}');
  const origem = (sessionStorage.getItem('wizard.origem')||'');
  document.getElementById('toolbarInfo').textContent =
    `Acordo ID: ${acordo?.acordoId ?? acordo?.id ?? '—'} • Contrato: ${acordo?.numContrato ?? acordo?.contrato_id ?? acordo?.numeroContrato ?? '—'}`;

  const fmtBRL = v => Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  const toNum = v => {
    if (v == null) return 0;
    if (typeof v === 'number') return v;
    const n = Number(String(v).replace(/\./g,'').replace(',', '.'));
    return isNaN(n) ? 0 : n;
  };
  const parseDate = s => s ? new Date(s) : null;
  const fmtDate = d => d ? d.toLocaleDateString('pt-BR') : '—';
  const startOfDay = d => { const x=new Date(d); x.setHours(0,0,0,0); return x; };
  const today = startOfDay(new Date());

  /* ========= ELEGIBILIDADE (helper único) ========= */
  const elig = window.SAElig.compute(acordo, origem);
  const ANTEC_ENABLED = !!elig.podeAntec;

  // Banner de elegibilidade
  const eligCard  = document.getElementById('eligCard');
  const eligAlert = document.getElementById('eligAlert');
  const eligHint  = document.getElementById('eligHint');

  eligCard.style.display = 'block';
  if (ANTEC_ENABLED){
    eligAlert.className = 'alert alert-ok';
    eligAlert.innerHTML = `✔️ Antecipação habilitada para este acordo <strong>(ATIVO, situação NORMAL, sem atrasos abertos e parcela do mês paga ou a vencer)</strong>.`;
    eligHint.textContent = 'Observação: acordo ATIVO implica status 3 (ACEITO).';
  }else{
    eligAlert.className = 'alert alert-bad';
    const itens = elig.reasonsAntec.map(r=>`<li>${r}</li>`).join('');
    eligAlert.innerHTML = `⚠️ Antecipação indisponível para este acordo. <br><ul>${itens}</ul>`;
    eligHint.textContent = 'Dica: regularize a parcela atrasada e/ou aguarde a parcela do mês vencer/pagar para liberar.';
  }

  /* ========= Parcelas (render sempre) ========= */
  function dedupParcelas(arr){
    const map = new Map();
    (arr||[]).forEach(p=>{
      const key = p?.parcela_id ?? `${p?.acordo_id||''}:${p?.numeroParcela||''}:${p?.dataVencimento||''}`;
      if(!map.has(key)) map.set(key, p);
    });
    return [...map.values()];
  }
  function isPaga(p){
    const st  = String(p?.situacao || '').toUpperCase();
    const st2 = String(p?.situacaoPagamento || '').toUpperCase();
    const pagoPorStatus = /(LIQUID|QUITAD|PAG[OA]|PROCESS)/.test(st) || /(LIQUID|PROCESS)/.test(st2);
    const pagoPorValor  = toNum(p?.valor_pago) >= Math.max(0, toNum(p?.valor));
    const temDataPg     = !!p?.data_pagamento;
    return pagoPorStatus || pagoPorValor || temDataPg;
  }
  function sortParcelas(arr){
    return [...arr].sort((a,b)=>{
      const an = Number(a?.numeroParcela ?? 0), bn = Number(b?.numeroParcela ?? 0);
      if (an !== bn) return an - bn;
      const ao = Number(a?.ordem ?? 0), bo = Number(b?.ordem ?? 0);
      if (ao !== bo) return ao - bo;
      const ad = a?.dataVencimento ? new Date(a.dataVencimento).getTime() : 0;
      const bd = b?.dataVencimento ? new Date(b.dataVencimento).getTime() : 0;
      return ad - bd;
    });
  }
  const parcelas = sortParcelas(dedupParcelas(elig.parcelas || acordo.parcelas || []));
  const valorAcordo = parcelas.reduce((s,p)=> s + toNum(p?.valor), 0);
  const numTotal = Number(acordo?.NumeroParcela ?? acordo?.numeroParcela ?? parcelas.length) || parcelas.length;

  // Render 6 colunas
  function renderTabelaParcelas6(){
    const tbody = document.getElementById('tbodyParcelas');
    if (!parcelas.length){
      tbody.innerHTML = `<tr><td colspan="6" style="text-align:left;padding:14px">Este acordo não possui parcelas.</td></tr>`;
      return;
    }
    let html = '';
    for (const p of parcelas){
      const numero   = p?.numeroParcela ?? '—';
      const valor    = toNum(p?.valor);
      const vencD    = p?.dataVencimento ? new Date(p.dataVencimento) : null;
      const pv       = valorPresenteParcela(valor, p?.dataVencimento);
      const paga     = isPaga(p);
      const valorPago= paga ? (toNum(p?.valor_pago) || valor) : 0;
      const dtPago   = paga ? fmtDate(parseDate(p?.data_pagamento)) : '—';
      html += `<tr>
        <td>${numero}</td>
        <td class="money">${fmtBRL(valor)}</td>
        <td>${fmtDate(vencD)}</td>
        <td class="money">${fmtBRL(pv)}</td>
        <td class="money">${fmtBRL(valorPago)}</td>
        <td>${dtPago}</td>
      </tr>`;
    }
    tbody.innerHTML = html;
    document.getElementById('resumoAcordo').innerHTML =
      `Acordo ID: <strong>${acordo?.acordoId ?? acordo?.id ?? '—'}</strong> • Nº parcelas (total): <strong>${numTotal}</strong> • Valor do acordo (soma): <strong>${fmtBRL(valorAcordo)}</strong>`;
  }

  /* ========= Taxas / VP / FV ========= */
  let taxaAnual = 0.20;                  // 20% a.a. default
  let i_m = Math.pow(1 + taxaAnual, 1/12) - 1; // mensal efetiva
  let i_d = Math.pow(1 + i_m, 1/30) - 1;       // diária aprox (30d)
  const statsEls = document.getElementById('stats').querySelectorAll('.stat strong');

  function paintStats(){
    if (statsEls.length < 3) return;
    statsEls[0].textContent = fmtBRL(saldoFVOriginal);
    statsEls[1].textContent = fmtBRL(VPOriginal);
    statsEls[2].textContent = `${(i_m*100).toFixed(3)}% a.m. (${(taxaAnual*100).toFixed(2)}% a.a.)`;
  }
  function setTaxa(ta){
    taxaAnual = Math.max(0, ta);
    i_m = Math.pow(1 + taxaAnual, 1/12) - 1;
    i_d = Math.pow(1 + i_m, 1/30) - 1;
    if (ANTEC_ENABLED){
      desenharSugestoes([30,36,42,48]);
      renderTabelaParcelas6();
      recomputarBases();
      paintStats();
    }
  }

  // Modal de taxa
  const modal = document.getElementById('modalTaxa');
  const taxaInput = document.getElementById('taxaAnualInput');
  const modalHint = document.getElementById('modalHint');
  function abrirModalTaxa(){
    taxaInput.value = (taxaAnual*100).toFixed(2);
    modalHint.textContent = 'Informe a taxa anual de desconto de antecipação (ex.: 20%).';
    modal.style.display='flex'; modal.setAttribute('aria-hidden','false');
  }
  document.getElementById('btnAnt').onclick = ()=>{ if(ANTEC_ENABLED) abrirModalTaxa(); };
  document.getElementById('confirmTaxa').onclick = ()=>{
    const ta = Number(taxaInput.value)/100;
    setTaxa(isFinite(ta) ? ta : 0.20);
    modal.style.display='none'; modal.setAttribute('aria-hidden','true');
  };
  modal.addEventListener('click', (e)=>{ if(e.target===modal){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); } });

  function valorPresenteParcela(valorFV, venc){
    const fv = toNum(valorFV);
    if (!venc) return fv;
    const d = new Date(venc); d.setHours(0,0,0,0);
    const diffDays = Math.round((d - today) / (24*60*60*1000));
    if (diffDays <= 0) return fv;
    const fator = Math.pow(1 + i_d, diffDays);
    return fv / fator;
  }

  /* ========= Bases Simulação ========= */
  let futuras = []; let VPOriginal = 0; let saldoFVOriginal = 0;
  function recomputarBases(){
    const futurasVals = []; const futurasObjs = []; let t = 0;
    for(const p of parcelas){
      if(!isPaga(p)){
        t += 1;
        const v = toNum(p.valor);
        futurasVals.push(v);
        futurasObjs.push({valor:v, t});
      }
    }
    futuras = futurasObjs.slice();
    saldoFVOriginal = futurasVals.reduce((a,b)=>a+b,0);
    VPOriginal = futurasVals.reduce((acc,v,idx)=>acc + v / Math.pow(1+i_m, idx+1), 0);
    paintStats();
  }

  /* ========= Motor ========= */
  function PMTfromPV(PV,n){ return PV * i_m / (1 - Math.pow(1+i_m, -n)); }
  function NfromPVPMT(PV,PMT){
    if (PMT <= PV * i_m) return Infinity;
    return - Math.log(1 - PV * i_m / PMT) / Math.log(1+i_m);
  }
  function desenharSugestoes(prazos){
    const tb = document.getElementById('tabelaSugestoes');
    if (!ANTEC_ENABLED){
      tb.innerHTML = `<tr><td colspan="2">Operação indisponível para este acordo.</td></tr>`;
      return;
    }
    let linhas = '';
    prazos.forEach(m=>{
      const pmt = PMTfromPV(VPOriginal, m);
      linhas += `<tr class="clickable-row" data-meses="${m}" data-pmt="${pmt}">
        <td>${m}</td><td>${fmtBRL(pmt)}</td>
      </tr>`;
    });
    tb.innerHTML = linhas || `<tr><td colspan="2">Defina a taxa para ver sugestões.</td></tr>`;
    tb.onclick = e=>{
      if (!ANTEC_ENABLED) return;
      const tr = e.target.closest('tr.clickable-row'); if(!tr) return;
      const m = parseInt(tr.getAttribute('data-meses'),10);
      const pmt = Number(tr.getAttribute('data-pmt'));
      const cellIndex = Array.from(tr.children).indexOf(e.target.closest('td'));
      if(cellIndex === 0){ document.getElementById('numParcelas').value = m; simularPorPrazo(); }
      else { document.getElementById('valorParcela').value = fmtBRL(pmt).replace(/[^\d,.-]/g,''); simularPorValor(); }
    };
  }

  // Gera cronograma de simulação mantendo VP e comparando com cronograma original (para desconto nominal)
  function simularAgendaPorPMT(PV, PMT, maxN){
    let nRaw = NfromPVPMT(PV, PMT);
    let n = Math.ceil(isFinite(nRaw) ? nRaw : maxN); n = Math.min(n, maxN);

    // PV/FV das parcelas originais não pagas (por posição temporal)
    const origPV = futuras.map(f => f.valor / Math.pow(1+i_m, f.t));
    const origFV = futuras.map(f => f.valor);
    let origIdx = 0; let origPVRem = origPV.slice(); let origFVRem = origFV.slice();

    let R = PV; const linhas = [];
    for(let k=1; k<=n; k++){
      const pvBase = PMT / Math.pow(1+i_m, k);
      const pvPay = (k===n || pvBase >= R) ? R : pvBase;
      const fvPay = pvPay * Math.pow(1+i_m, k);
      R = +(R - pvPay); if (R < 1e-8) R = 0;

      // Equivalência contra cronograma original
      let restantePV = pvPay, substituidoFV = 0;
      while(restantePV > 1e-10 && origIdx < origPVRem.length){
        const pvDisp = origPVRem[origIdx], fvDisp = origFVRem[origIdx];
        if (pvDisp <= restantePV + 1e-10){
          substituidoFV += fvDisp; restantePV -= pvDisp; origIdx += 1;
        }else{
          const fraq = restantePV / pvDisp;
          substituidoFV += fvDisp * fraq;
          origPVRem[origIdx] = pvDisp - restantePV;
          origFVRem[origIdx] = fvDisp * (1 - fraq);
          restantePV = 0;
        }
      }
      const descontoNominal = substituidoFV - fvPay;
      linhas.push({k, fv:fvPay, pv:pvPay, saldoVPpos:R, descontoNominal});
      if (R === 0) break;
    }
    const totalFV = linhas.reduce((s,l)=>s+l.fv,0);
    let cumul = 0; for (const l of linhas){ cumul += l.fv; l.saldoFuturoPos = +(totalFV - cumul); }
    return {linhas, totalFV, n: linhas.length};
  }

  function montarTabelaSimulacao(sim){
    let html = `<div class="table-wrap"><table><thead><tr>
      <th>#</th><th>Parcela (R$)</th><th>VP parcela (R$)</th><th>Desconto / Encargo (R$)</th><th>Saldo futuro restante (R$)</th><th>Saldo VP restante (R$)</th>
    </tr></thead><tbody>`;
    sim.linhas.forEach(l=>{
      const tagClass = l.descontoNominal >= 0 ? 'tag-ok' : 'tag-warn';
      const tagLabel = l.descontoNominal >= 0 ? 'Desconto' : 'Encargo';
      html += `<tr>
        <td>${l.k}</td>
        <td class="money">${fmtBRL(l.fv)}</td>
        <td class="money">${fmtBRL(l.pv)}</td>
        <td class="${tagClass}">${tagLabel}: ${fmtBRL(Math.abs(l.descontoNominal))}</td>
        <td class="money">${fmtBRL(sim.linhas.length===l.k ? 0 : l.saldoFuturoPos)}</td>
        <td class="money">${fmtBRL(l.saldoVPpos)}</td>
      </tr>`;
    });
    html += `</tbody></table></div>`;
    return html;
  }
  function montarComparativo(totalFVSim, nSim){
    const nOrig = futuras.length;
    const diffFV = saldoFVOriginal - totalFVSim; // >0 = desconto
    const tag = diffFV >= 0 ? 'tag-ok' : 'tag-warn';
    const rot = diffFV >= 0 ? 'Desconto nominal' : 'Encargo nominal';
    return `
      <div class="box">
        <h4>Original</h4>
        <div class="row-just"><span>Nº parcelas restantes</span><strong>${nOrig}</strong></div>
        <div class="row-just"><span>Saldo devedor (FV)</span><strong>${fmtBRL(saldoFVOriginal)}</strong></div>
        <div class="row-just"><span>Valor Presente</span><strong>${fmtBRL(VPOriginal)}</strong></div>
      </div>
      <div class="box">
        <h4>Simulação</h4>
        <div class="row-just"><span>Nº de parcelas</span><strong>${nSim}</strong></div>
        <div class="row-just"><span>Total a pagar (FV)</span><strong>${fmtBRL(totalFVSim)}</strong></div>
        <div class="row-just ${tag}"><span>${rot}</span><strong>${fmtBRL(Math.abs(diffFV))}</strong></div>
        <div class="row-just"><span>VP (≈ original)</span><strong>${fmtBRL(VPOriginal)}</strong></div>
      </div>`;
  }

  /* ========= Ações (inputs) ========= */
  function toNumberLoose(str){
    if (typeof str !== 'string') return Number(str);
    const s = str.replace(/\s/g,'').replace(/\./g,'').replace(',', '.');
    const n = Number(s);
    return isNaN(n) ? NaN : n;
  }
  function getNumberFromInput(id){ return toNumberLoose(document.getElementById(id).value); }
  function setCurrencyReadonly(id, num){ document.getElementById(id).value = fmtBRL(num).replace(/[^\d,.-]/g,''); }

  function simularPorValor(){
    if (!ANTEC_ENABLED){
      alert('Antecipação indisponível para este acordo.\n\nMotivos:\n- ' + elig.reasonsAntec.join('\n- '));
      return;
    }
    const PMT = getNumberFromInput('valorParcela');
    const maxN = parseInt(document.getElementById('maxParcelas').value || '48',10);
    const minPMT = getNumberFromInput('minParcela') || 100;
    if (!isFinite(PMT)){ alert('Digite o valor da parcela.'); return; }
    if (PMT < minPMT){ alert(`Valor mínimo da parcela: ${fmtBRL(minPMT)}`); return; }
    const sim = simularAgendaPorPMT(VPOriginal, PMT, maxN);
    let html = `<h3>Simulação (por valor de parcela)</h3>`;
    html += montarTabelaSimulacao(sim);
    html += `<div class="compare">${montarComparativo(sim.totalFV, sim.n)}</div>`;
    document.getElementById('resultado').innerHTML = html;
  }

  function simularPorPrazo(){
    if (!ANTEC_ENABLED){
      alert('Antecipação indisponível para este acordo.\n\nMotivos:\n- ' + elig.reasonsAntec.join('\n- '));
      return;
    }
    let n = parseInt(document.getElementById('numParcelas').value,10);
    const maxN = parseInt(document.getElementById('maxParcelas').value || '48',10);
    const minPMT = getNumberFromInput('minParcela') || 100;
    if (!n){ alert('Digite o número de parcelas.'); return; }
    if (n > maxN){ alert(`Máximo permitido: ${maxN} parcelas.`); n = maxN; }
    const PMT = VPOriginal * i_m / (1 - Math.pow(1+i_m, -n));
    if (PMT < minPMT){ alert(`Para ${n} parcelas, a parcela calculada ficou abaixo do mínimo (${fmtBRL(minPMT)}).`); return; }
    const sim = simularAgendaPorPMT(VPOriginal, PMT, n);
    let html = `<h3>Simulação (por prazo)</h3><div class="hint">Parcela calculada: <strong>${fmtBRL(PMT)}</strong></div>`;
    html += montarTabelaSimulacao(sim);
    html += `<div class="compare">${montarComparativo(sim.totalFV, sim.n)}</div>`;
    document.getElementById('resultado').innerHTML = html;
  }

  document.getElementById('btnPorValor').addEventListener('click', simularPorValor);
  document.getElementById('btnPorPrazo').addEventListener('click', simularPorPrazo);
  document.getElementById('valorParcela').addEventListener('keydown', e=>{ if(e.key==='Enter') simularPorValor(); });
  document.getElementById('numParcelas').addEventListener('keydown', e=>{ if(e.key==='Enter') simularPorPrazo(); });

  /* ========= Inicialização ========= */
  setCurrencyReadonly('minParcela', 100);
  renderTabelaParcelas6();
  // sempre calculamos as bases para exibir stats, mesmo se indisponível
  recomputarBases();
  desenharSugestoes([30,36,42,48]);
  paintStats();

  // Se a operação estiver indisponível, travamos inputs com mensagem
  if (!ANTEC_ENABLED){
    const reasonsText = elig.reasonsAntec.join(' • ');
    const disableWithTitle = (el)=>{ if(el){ el.disabled = true; el.title = 'Indisponível: ' + reasonsText; } };
    disableWithTitle(document.getElementById('btnAnt'));
    disableWithTitle(document.getElementById('btnPorValor'));
    disableWithTitle(document.getElementById('btnPorPrazo'));
    disableWithTitle(document.getElementById('valorParcela'));
    disableWithTitle(document.getElementById('numParcelas'));
  }
})();
</script>